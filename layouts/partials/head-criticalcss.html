{{- $fontsSrc := "local" -}}
{{- /* "local" or "CFF"; fallback is system fonts. With CFF, remember that
the CSP's `style-src` must allow "unsafe-inline" because CFF injects a `style`
AFTER the CFP Page Function injects the CSP. */ -}}
{{- with $fontsSrc -}}
	{{- if eq . "local" -}}
		{{- $fonts := resources.Get "css/fonts-Inter.css" -}}
		{{- with $fonts }}
			<link rel="preload" as="font" href="/fonts/InterVariable-4-0-Regular_subset.woff2" type="font/woff2" media="screen and (min-width: 1024px)" crossorigin>
			{{/* DO NOT preload italic; it's not always needed (e.g., home page, search page, etc.). */}}
			<style media="screen and (min-width: 1024px)">{{ .Content | safeCSS }}</style>
		{{- end -}}
	{{- else if eq . "CFF" -}}
		{{- $URLopen := "https://fonts.googleapis.com/css2?family=" -}}
		{{- $fontSans := "Libre+Franklin" -}}
			{{- $itemsSans := "ital,wght" -}} {{/* ital,opsz,wdth,wght,GRAD */}}
			{{- $varsSans := "100..900" -}}
			{{- $URLSans := print $URLopen $fontSans ":" $itemsSans "@0," $varsSans ";1," $varsSans "&display=swap" -}}
		{{- $fontSerif := "" -}}
			{{- $itemsSerif := "ital,wght" -}} {{/* ital,opsz,wdth,wght,GRAD */}}
			{{- $varsSerif := "100..900" -}}
			{{- $URLSerif := print $URLopen $fontSerif ":" $itemsSerif "@0," $varsSerif ";1," $varsSerif "&display=swap" -}}
		{{- $fontMono := "" -}}
			{{- $itemsMono := "" -}} {{/* ital,opsz,wdth,wght,GRAD */}}
			{{- $varsMono := "" -}}
			{{- $URLMono := print $URLopen $fontMono ":" $itemsMono "@0," $varsMono ";1," $varsMono "&display=swap" -}}
		<link rel="preconnect" href="https://fonts.googleapis.com" media="screen and (min-width: 1024px)" crossorigin>
		<link rel="preconnect" href="https://fonts.gstatic.com" media="screen and (min-width: 1024px)" crossorigin>
		{{/* https://discourse.gohugo.io/t/how-to-unescape-plus-sign-in-url-re-cloudflare-fonts/46734 */}}
		{{ with $fontSans -}}
			<link {{ printf "href=%q" $URLSans | safeHTMLAttr }} rel="stylesheet" media="screen and (min-width: 1024px)">
		{{- end }}
		{{ with $fontSerif -}}
			<link {{ printf "href=%q" $URLSerif | safeHTMLAttr }} rel="stylesheet" media="screen and (min-width: 1024px)">
		{{- end }}
		{{- with $fontMono -}}
			<link {{ printf "href=%q" $URLMono | safeHTMLAttr }} rel="stylesheet" media="screen and (min-width: 1024px)">
		{{- end }}
	{{/* otherwise, we fall back to system fonts */}}
	{{- end }}
{{- end }}

{{ $css := (resources.Match "css/partials/0*.css") | resources.Concat "css/critical.css" }}
{{- if hugo.IsProduction -}}
	{{- $css = $css | postCSS -}}
{{- end -}}
{{- with $css }}
	<style media="screen">{{ .Content | safeCSS }}</style>
{{- end }}
